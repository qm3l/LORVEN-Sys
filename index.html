<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ÙˆØ±Ú¤ÙŠÙ† Â· Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„Ø£Ø°ÙƒÙ‰</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Barcode Scanner -->
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    
    <style>
        /* ========== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ù†ÙŠÙ‚ ========== */
        :root {
            --bg: #FDF8F5;
            --text: #2C3A4F;
            --accent-1: #FF8A9C;
            --accent-2: #A7C7E7;
            --gradient: linear-gradient(145deg, #FF8A9C, #A7C7E7);
            --success: #A3D9A5;
            --warning: #FFD3B5;
            --danger: #FFB3B3;
            --gray-50: #F9F6F4;
            --gray-100: #F0EBE8;
            --gray-200: #E0D6D0;
            --gray-500: #8F8A88;
            --gray-800: #3D3A36;
            
            --shadow-sm: 0 6px 16px rgba(44,58,79,0.04);
            --shadow-md: 0 12px 24px rgba(44,58,79,0.06);
            --shadow-lg: 0 20px 32px rgba(44,58,79,0.08);
            
            --radius-md: 20px;
            --radius-lg: 30px;
            --radius-xl: 40px;
            
            --font: 'IBM Plex Sans Arabic', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
        }

        /* ØªØ·Ø¨ÙŠÙ‚ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø·Ø§Ø± */
        .app-container {
            width: 100%;
            max-width: 420px;
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.02);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© â€“ Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· */
        .status-bar {
            padding: 14px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-800);
            background: white;
            border-bottom: 1px solid var(--gray-100);
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¹ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
        .page-header {
            display: flex;
            align-items: center;
            padding: 14px 22px;
            background: white;
            border-bottom: 1px solid var(--gray-100);
        }
        .back-btn {
            font-size: 24px;
            color: var(--accent-1);
            margin-left: 16px;
            cursor: pointer;
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            background: var(--gray-50);
            transition: 0.2s;
        }
        .back-btn:hover { background: var(--gray-100); }
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            flex: 1;
        }
        .notification-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 22px;
            background: white;
            scrollbar-width: thin;
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ© */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-top: 1px solid var(--gray-100);
        }
        .nav-btn {
            background: transparent;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            border-radius: 40px;
            color: var(--gray-500);
            font-size: 12px;
            font-weight: 500;
            transition: 0.2s;
            cursor: pointer;
        }
        .nav-btn i { font-size: 24px; }
        .nav-btn.active {
            background: var(--gradient);
            color: white;
            box-shadow: 0 8px 18px rgba(255,138,156,0.25);
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª â€“ Ø®Ù„ÙÙŠØ© ÙƒØ§Ù…Ù„Ø© */
        .stat-card {
            background: var(--gradient);
            border-radius: 28px;
            padding: 20px;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
        }
        .stat-icon {
            width: 48px; height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
            color: white;
        }
        .stat-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .stat-label { font-size: 14px; opacity: 0.9; }

        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        .form-group { margin-bottom: 20px; position: relative; }
        .form-label {
            display: block; font-size: 14px; font-weight: 600;
            margin-bottom: 8px; color: var(--gray-800);
        }
        .form-control {
            width: 100%; padding: 16px 20px;
            background: var(--gray-50);
            border: 1.5px solid var(--gray-200);
            border-radius: 30px;
            font-size: 15px;
            transition: 0.2s;
            font-family: var(--font);
        }
        .form-control:focus {
            outline: none; border-color: var(--accent-1);
            background: white; box-shadow: 0 0 0 4px rgba(255,138,156,0.1);
        }

        .btn {
            padding: 16px 24px; border-radius: 40px; font-size: 16px;
            font-weight: 600; border: none; cursor: pointer;
            transition: 0.2s; display: inline-flex; align-items: center;
            justify-content: center; gap: 10px;
        }
        .btn-primary { background: var(--gradient); color: white; box-shadow: 0 8px 18px rgba(255,138,156,0.25); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(255,138,156,0.35); }
        .btn-outline { background: white; border: 1.5px solid var(--accent-1); color: var(--accent-1); }
        .btn-outline:hover { background: rgba(255,138,156,0.05); }
        .btn-wa { background: #25D366; color: white; }
        .btn-wa:hover { background: #20B859; }

        /* Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© â€“ Ù…Ù„ÙˆÙ†Ø© ÙˆØ¬Ø°Ø§Ø¨Ø© */
        .actions-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            margin: 20px 0;
        }
        .action-item {
            background: white; border: 1px solid var(--gray-200);
            border-radius: 26px; padding: 16px 8px;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            cursor: pointer; transition: 0.2s;
        }
        .action-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .action-icon {
            width: 60px; height: 60px;
            background: var(--gradient);
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 28px;
            box-shadow: 0 6px 14px rgba(255,138,156,0.3);
        }
        .action-label { font-size: 12px; font-weight: 600; color: var(--text); }

        /* Ù…Ù†ØªØ¬Ø§Øª */
        .products-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .products-title { font-size: 24px; font-weight: 700; color: var(--text); } /* Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø­Ø¯ */
        .products-actions { display: flex; gap: 10px; }
        .products-actions button {
            width: 48px; height: 48px; border-radius: 20px;
            border: 1px solid var(--gray-200); background: white;
            color: var(--accent-1); font-size: 22px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .products-actions button:hover { background: var(--accent-1); color: white; }

        .products-grid-container { max-height: 460px; overflow-y: auto; margin-top: 8px; }
        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .product-card {
            background: white; border-radius: 26px; padding: 18px;
            border: 1px solid var(--gray-100); box-shadow: var(--shadow-sm);
        }
        .product-icon {
            width: 64px; height: 64px; background: var(--gradient);
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 28px; margin-bottom: 12px;
        }

        /* ÙØ§ØªÙˆØ±Ø© */
        .invoice-item {
            display: flex; align-items: center; padding: 16px;
            background: var(--gray-50); border-radius: 24px; margin-bottom: 10px;
        }
        .customer-card, .products-card, .summary-card {
            background: white; border-radius: 28px; padding: 20px;
            margin-bottom: 20px; border: 1px solid var(--gray-100);
        }

        /* ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€“ ÙƒÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØªØ¹Ù…Ù„ */
        .settings-list { background: white; border-radius: 32px; border: 1px solid var(--gray-100); overflow: hidden; }
        .settings-item {
            display: flex; align-items: center; padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: 0.2s;
        }
        .settings-item:last-child { border-bottom: none; }
        .settings-item:hover { background: var(--gray-50); }
        .settings-icon {
            width: 52px; height: 52px; background: rgba(255,138,156,0.08);
            border-radius: 18px; display: flex; align-items: center; justify-content: center;
            color: var(--accent-1); font-size: 22px; margin-left: 18px;
        }
        .settings-content { flex: 1; }
        .settings-title { font-weight: 700; color: var(--text); margin-bottom: 6px; }
        .settings-subtitle { font-size: 13px; color: var(--gray-500); }
        .settings-arrow { color: var(--gray-500); font-size: 18px; }

        /* Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø£Ù†ÙŠÙ‚Ø© */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44,58,79,0.6); backdrop-filter: blur(6px);
            align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-content {
            background: white; width: 90%; max-width: 380px;
            border-radius: 36px; overflow: hidden; box-shadow: var(--shadow-lg);
            animation: fadeIn 0.25s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-header {
            padding: 24px; background: var(--gradient); color: white;
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-title { font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .modal-close { font-size: 28px; cursor: pointer; opacity: 0.8; }
        .modal-close:hover { opacity: 1; }
        .modal-body { padding: 28px; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text); color: white; padding: 16px 32px;
            border-radius: 50px; font-weight: 500; box-shadow: var(--shadow-lg);
            z-index: 3000; opacity: 0; transition: 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ */
        .datalist-customers {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border-radius: 24px; box-shadow: var(--shadow-md);
            max-height: 220px; overflow-y: auto; z-index: 150; display: none;
        }
        .datalist-item { padding: 16px 20px; border-bottom: 1px solid var(--gray-100); cursor: pointer; }
        .datalist-item:hover { background: var(--gray-50); }

        /* Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« */
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border-radius: 24px; box-shadow: var(--shadow-md);
            max-height: 280px; overflow-y: auto; z-index: 100; display: none;
        }
        .search-result-item {
            display: flex; align-items: center; padding: 16px;
            border-bottom: 1px solid var(--gray-100); cursor: pointer;
        }
        .search-result-item:hover { background: var(--gray-50); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· -->
        <div class="status-bar">
            <span id="liveTime"></span>
            <span></span> <!-- ÙØ§Ø±Øº -->
        </div>

        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ -->
        <div id="dynamicHeader" class="page-header"></div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div id="mainContent" class="main-content"></div>

        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
        <div class="bottom-nav" id="bottomNav">
            <button class="nav-btn" onclick="switchPage('dashboard')"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
            <button class="nav-btn" onclick="switchPage('products')"><i class="fas fa-box"></i><span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span></button>
            <button class="nav-btn" onclick="switchPage('invoices')"><i class="fas fa-receipt"></i><span>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span></button>
            <button class="nav-btn" onclick="switchPage('reports')"><i class="fas fa-chart-pie"></i><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></button>
            <button class="nav-btn" onclick="switchPage('settings')"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></button>
        </div>
    </div>

    <div class="toast" id="toast">Ù„ÙˆØ±Ú¤ÙŠÙ† ğŸŒ¸</div>

    <!-- ========== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© ========== -->

    <!-- ÙˆØ§ØªØ³Ø§Ø¨ -->
    <div class="modal" id="whatsappModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
                <div class="modal-close" onclick="closeModal('whatsappModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div id="whatsappPreview" style="background: var(--gray-50); padding: 20px; border-radius: 24px; margin-bottom: 24px; direction: ltr; text-align: left; font-family: monospace; white-space: pre-wrap;"></div>
                <div class="form-group">
                    <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„Ø©</label>
                    <input type="tel" class="form-control" id="whatsappPhoneNumber" placeholder="771234567">
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-outline" style="flex:1;" onclick="closeModal('whatsappModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="btn btn-wa" style="flex:1;" onclick="sendWhatsApp()">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-plus"></i> Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</div>
                <div class="modal-close" onclick="closeModal('addProductModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="text" class="form-control" id="newProductName" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙŠØ±ÙˆÙ… ÙÙŠØªØ§Ù…ÙŠÙ† Ø³ÙŠ">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                    <input type="text" class="form-control" id="newProductBarcode" placeholder="Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„ØªÙƒÙ„ÙØ©</label>
                        <input type="number" class="form-control" id="newProductCost" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø³Ø¹Ø±</label>
                        <input type="number" class="form-control" id="newProductPrice" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
                    <input type="number" class="form-control" id="newProductStock" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„ÙØ¦Ø©</label>
                    <select class="form-control" id="newProductCategory">
                        <option>Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©</option>
                        <option>Ù…ÙƒÙŠØ§Ø¬</option>
                        <option>Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø´Ø¹Ø±</option>
                        <option>Ø¹Ø·ÙˆØ±</option>
                        <option>Ù…Ù†ØªØ¬Ø§Øª Ø·Ø¨ÙŠØ¹ÙŠØ©</option>
                    </select>
                </div>
                <button class="btn btn-primary" style="width:100%;" onclick="addNewProduct()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
            </div>
        </div>
    </div>

    <!-- ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ -->
    <div class="modal" id="editProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</div>
                <div class="modal-close" onclick="closeModal('editProductModal')">&times;</div>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="text" class="form-control" id="editProductName">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
                    <input type="text" class="form-control" id="editProductBarcode">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group"><label>Ø§Ù„ØªÙƒÙ„ÙØ©</label><input type="number" class="form-control" id="editProductCost"></div>
                    <div class="form-group"><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" class="form-control" id="editProductPrice"></div>
                </div>
                <div class="form-group"><label>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label><input type="number" class="form-control" id="editProductStock"></div>
                <div class="form-group"><label>Ø§Ù„ÙØ¦Ø©</label><select class="form-control" id="editProductCategory"></select></div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-outline" style="flex:1;" onclick="closeModal('editProductModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="btn btn-primary" style="flex:1;" onclick="updateProduct()">ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <button class="btn btn-outline" style="width:100%; margin-top: 16px; color: var(--danger); border-color: var(--danger);" onclick="deleteProduct()">Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬</button>
            </div>
        </div>
    </div>

    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div class="modal" id="invoiceDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-file-invoice"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
                <div class="modal-close" onclick="closeModal('invoiceDetailsModal')">&times;</div>
            </div>
            <div class="modal-body" id="invoiceDetailsContent">
                <!-- ØªÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø¨Ø±Ù‚Ù…Ù‡Ø§ -->
    <div class="modal" id="searchInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-search"></i> Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
                <div class="modal-close" onclick="closeModal('searchInvoiceModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                    <input type="text" class="form-control" id="invoiceSearchNumber" placeholder="Ù…Ø«Ø§Ù„: LVN-20260213-042">
                </div>
                <button class="btn btn-primary" style="width:100%; margin-bottom: 16px;" onclick="findInvoiceByNumber()">Ø¨Ø­Ø«</button>
                <div id="invoiceSearchResult"></div>
            </div>
        </div>
    </div>

    <!-- ÙØ§ØªÙˆØ±Ø© Ø´Ù‡Ø±ÙŠØ© -->
    <div class="modal" id="monthlyInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-calendar-alt"></i> ÙØ§ØªÙˆØ±Ø© Ø´Ù‡Ø±ÙŠØ©</div>
                <div class="modal-close" onclick="closeModal('monthlyInvoiceModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„Ø©</label>
                    <select class="form-control" id="monthlyCustomerSelect"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label>
                    <input type="month" class="form-control" id="monthlyMonth" value="${new Date().toISOString().slice(0,7)}">
                </div>
                <button class="btn btn-primary" style="width:100%;" onclick="generateMonthlyInvoice()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                <div id="monthlyInvoiceResult" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- ========== Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ========== -->

    <div class="modal" id="settingsGeneral">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-sliders-h"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div><div class="modal-close" onclick="closeModal('settingsGeneral')">&times;</div></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</label><select class="form-control" id="darkMode"><option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ</option><option value="light">ÙØ§ØªØ­</option><option value="dark">Ø¯Ø§ÙƒÙ†</option></select></div>
                <div class="form-group"><label class="form-label">Ø§Ù„Ù„ØºØ©</label><select class="form-control" id="appLanguage"><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="en">English</option></select></div>
                <button class="btn btn-primary" style="width:100%;" onclick="saveGeneral()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsCountryCode">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-globe"></i> Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©</div><div class="modal-close" onclick="closeModal('settingsCountryCode')">&times;</div></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Ø§Ø®ØªØ± Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©</label><select class="form-control" id="countryCodeSelect"><option value="967">967 (Ø§Ù„ÙŠÙ…Ù†)</option><option value="966">966 (Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©)</option><option value="965">965 (Ø§Ù„ÙƒÙˆÙŠØª)</option><option value="971">971 (Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª)</option><option value="other">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</option></select></div>
                <div id="customCountryCodeDiv" style="display:none;"><label class="form-label">Ø±Ù…Ø² Ù…Ø®ØµØµ</label><input class="form-control" id="customCountryCode"></div>
                <div style="margin-top:16px;"><label class="form-label">Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label><div style="display:flex; gap:20px;"><label><input type="radio" name="codeBehavior" value="prepend" checked> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ù…Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</label><label><input type="radio" name="codeBehavior" value="asis"> Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù‚Ù… ÙƒÙ…Ø§ Ù‡Ùˆ</label></div></div>
                <button class="btn btn-primary" style="width:100%; margin-top:24px;" onclick="saveCountryCode()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsTemplates">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-file-alt"></i> Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div><div class="modal-close" onclick="closeModal('settingsTemplates')">&times;</div></div>
            <div class="modal-body">
                <textarea class="form-control" id="whatsappTemplate" rows="12" style="resize:vertical;">Ø£Ù‡Ù„Ø§Ù‹ Ø¬Ù…ÙŠÙ„Ø© Ù„ÙˆØ±Ú¤ÙŠÙ†: {firstName} .. âœ¨

ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ÙƒÙ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙˆÙ†Ø­Ù†Ù Ø¨ÙƒÙ„ Ø­ÙØ¨ Ù†Ø¬Ù‡Ø² ØªÙØ§ØµÙŠÙ„Ù‡ Ø§Ù„Ø¢Ù† ğŸŒ¸

ğŸ†” *Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ :* #{orderId}
ğŸ“… *ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù…Ø§Ù„ :* {formattedDate}
ğŸ›ï¸ *Ù…Ù‚ØªÙ†ÙŠØ§ØªÙƒÙ :*
{items}

âœ¨ *Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ù…Ø§Ù„ :* {total} Ø±ÙŠØ§Ù„

Ù…Ù…ØªÙ†ÙŠÙ† Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ Ù„ÙˆØ±Ú¤ÙŠÙ† Ù„ÙŠÙƒÙˆÙ† Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø¬Ù…Ø§Ù„Ùƒ .. ğŸ¤</textarea>
                <button class="btn btn-primary" style="width:100%; margin-top:24px;" onclick="saveTemplate()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsBackup">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-cloud-upload-alt"></i> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</div><div class="modal-close" onclick="closeModal('settingsBackup')">&times;</div></div>
            <div class="modal-body text-center">
                <i class="fas fa-database" style="font-size:52px; color:var(--accent-1); margin-bottom:20px;"></i>
                <button class="btn btn-primary" style="width:100%; margin-bottom:12px;" onclick="exportBackup()"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø©</button>
                <button class="btn btn-outline" style="width:100%;" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©</button>
                <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importBackup(event)">
            </div>
        </div>
    </div>

    <div class="modal" id="settingsAds">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-bullhorn"></i> Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div><div class="modal-close" onclick="closeModal('settingsAds')">&times;</div></div>
            <div class="modal-body">
                <p style="margin-bottom:20px;">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±ÙˆØ¶ ÙˆØ±Ø³Ø§Ø¦Ù„ ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø§Øª.</p>
                <div class="form-group"><label class="form-label">Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label><textarea class="form-control" id="adMessage" rows="6"></textarea></div>
                <button class="btn btn-primary" style="width:100%;" onclick="sendAds()"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsCustomize">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-paint-brush"></i> ØªØ®ØµÙŠØµ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div><div class="modal-close" onclick="closeModal('settingsCustomize')">&times;</div></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label><input class="form-control" id="storeName" value="LORVEN"></div>
                <div class="form-group"><label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input class="form-control" id="logoUrl" placeholder="https://example.com/logo.png"></div>
                <button class="btn btn-primary" style="width:100%;" onclick="saveCustomization()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsSecurity">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-shield-alt"></i> Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©</div><div class="modal-close" onclick="closeModal('settingsSecurity')">&times;</div></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">ØªÙØ¹ÙŠÙ„ Ù‚ÙÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</label><select class="form-control" id="appLock"><option value="off">ØºÙŠØ± Ù…ÙØ¹Ù„</option><option value="pin">Ø±Ù…Ø² PIN</option><option value="fingerprint">Ø¨ØµÙ…Ø© Ø§Ù„Ø¥ØµØ¨Ø¹</option></select></div>
                <div id="pinField" style="display:none;"><label class="form-label">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² PIN</label><input type="password" class="form-control" id="pinCode" maxlength="4"></div>
                <button class="btn btn-primary" style="width:100%; margin-top:24px;" onclick="saveSecurity()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <script>
        // ========== Ù„ÙˆØ±Ú¤ÙŠÙ† 5.0 â€“ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ==========

        // ---------- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ----------
        let products = [];
        let invoices = [];
        let customersDB = [];
        let settings = {
            countryCode: '967',
            codeBehavior: 'prepend',
            whatsappTemplate: `Ø£Ù‡Ù„Ø§Ù‹ Ø¬Ù…ÙŠÙ„Ø© Ù„ÙˆØ±Ú¤ÙŠÙ†: {firstName} .. âœ¨\n\nØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ÙƒÙ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙˆÙ†Ø­Ù†Ù Ø¨ÙƒÙ„ Ø­ÙØ¨ Ù†Ø¬Ù‡Ø² ØªÙØ§ØµÙŠÙ„Ù‡ Ø§Ù„Ø¢Ù† ğŸŒ¸\n\nğŸ†” *Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ :* #{orderId}\nğŸ“… *ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù…Ø§Ù„ :* {formattedDate}\nğŸ›ï¸ *Ù…Ù‚ØªÙ†ÙŠØ§ØªÙƒÙ :*\n{items}\n\nâœ¨ *Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ù…Ø§Ù„ :* {total} Ø±ÙŠØ§Ù„\n\nÙ…Ù…ØªÙ†ÙŠÙ† Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ Ù„ÙˆØ±Ú¤ÙŠÙ† Ù„ÙŠÙƒÙˆÙ† Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø¬Ù…Ø§Ù„Ùƒ .. ğŸ¤`,
            storeName: 'LORVEN',
            logo: '',
            darkMode: 'auto',
            language: 'ar',
            appLock: 'off',
            pinCode: ''
        };
        let invoiceItems = [];
        let currentPage = 'dashboard';

        // ---------- ØªØ­Ù…ÙŠÙ„ / Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ----------
        function loadData() {
            try {
                const savedProducts = localStorage.getItem('lorven_products');
                if (savedProducts) products = JSON.parse(savedProducts);
                else {
                    // Ù…Ù†ØªØ¬Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© â€“ Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§ØªØŒ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙˆÙ†ØªÙˆØ§Ø²
                    products = [
                        { id: 1, name: 'Ø³ÙŠØ±ÙˆÙ… ÙÙŠØªØ§Ù…ÙŠÙ† Ø³ÙŠ Ø§Ù„Ù…Ø±ÙƒØ²', barcode: '6291100123456', price: 189, cost: 78, stock: 42, category: 'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©', icon: 'fa-flask' },
                        { id: 2, name: 'ÙƒØ±ÙŠÙ… ØªÙØªÙŠØ­ Ø§Ù„ÙˆØ¬Ù‡ Ø¨Ø§Ù„ÙƒÙˆÙ„Ø§Ø¬ÙŠÙ†', barcode: '6291100123457', price: 145, cost: 52, stock: 36, category: 'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©', icon: 'fa-spa' },
                        { id: 3, name: 'Ù…Ø§Ø³Ùƒ Ø§Ù„Ø°Ù‡Ø¨ Ù„Ù„ÙˆØ¬Ù‡ 24k', barcode: '6291100123458', price: 220, cost: 95, stock: 18, category: 'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©', icon: 'fa-crown' },
                        { id: 4, name: 'Ø£Ø­Ù…Ø± Ø´ÙØ§Ù‡ Ù…Ø§Øª Ø·ÙˆÙŠÙ„ Ø§Ù„Ø£Ù…Ø¯', barcode: '6291100123459', price: 79, cost: 24, stock: 84, category: 'Ù…ÙƒÙŠØ§Ø¬', icon: 'fa-paint-brush' },
                        { id: 5, name: 'ÙƒØ­Ù„ Ø³Ø§Ø¦Ù„ Ù…Ù‚Ø§ÙˆÙ… Ù„Ù„Ù…Ø§Ø¡', barcode: '6291100123460', price: 59, cost: 19, stock: 112, category: 'Ù…ÙƒÙŠØ§Ø¬', icon: 'fa-eye' },
                    ];
                }
                const savedInvoices = localStorage.getItem('lorven_invoices');
                invoices = savedInvoices ? JSON.parse(savedInvoices) : [];
                const savedSettings = localStorage.getItem('lorven_settings');
                if (savedSettings) settings = { ...settings, ...JSON.parse(savedSettings) };
                updateCustomersDB();
            } catch (e) { console.warn(e); }
        }
        function saveProducts() { localStorage.setItem('lorven_products', JSON.stringify(products)); }
        function saveInvoices() { localStorage.setItem('lorven_invoices', JSON.stringify(invoices)); }
        function saveSettings() { localStorage.setItem('lorven_settings', JSON.stringify(settings)); }
        function updateCustomersDB() {
            customersDB = [...new Map(invoices.map(inv => [inv.customerPhone, { name: inv.customerName, phone: inv.customerPhone }])).values()];
        }

        // ---------- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ----------
        function showToast(msg, icon = 'ğŸŒ¸') {
            const t = document.getElementById('toast');
            t.innerHTML = `${icon} ${msg}`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2200);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª (Ø¨Ø¯ÙˆÙ† Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª)
        function updateTime() {
            const now = new Date();
            document.getElementById('liveTime').innerHTML = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateTime, 1000);

        // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ (ØªØ³Ù„Ø³Ù„ÙŠ)
        function generateBarcode() {
            let max = 6291100000000;
            products.forEach(p => { if (parseInt(p.barcode) > max) max = parseInt(p.barcode); });
            return (max + 1).toString();
        }

        // ---------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø§Øª ----------
        const pages = {
            dashboard: { title: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', showBack: false },
            products: { title: 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', showBack: true },
            invoices: { title: 'ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©', showBack: true },
            reports: { title: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', showBack: true },
            settings: { title: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', showBack: true },
            history: { title: 'Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±', showBack: true }
        };

        function switchPage(page) {
            currentPage = page;
            // Ø§Ù„Ù‡ÙŠØ¯Ø±
            const header = document.getElementById('dynamicHeader');
            const pageInfo = pages[page] || { title: 'Ù„ÙˆØ±Ú¤ÙŠÙ†', showBack: true };
            header.innerHTML = `
                ${pageInfo.showBack ? '<div class="back-btn" onclick="goBack()"><i class="fas fa-chevron-right"></i></div>' : ''}
                <div class="page-title">${pageInfo.title}</div>
                ${page === 'dashboard' ? `<div class="notification-badge" onclick="switchPage('history')"><i class="fas fa-bell" style="color: var(--accent-1);"></i><span style="background: var(--accent-1); color: white; padding: 4px 10px; border-radius: 30px; font-size: 14px;">${invoices.length}</span></div>` : ''}
            `;
            // Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            renderPage(page);
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            const navOrder = ['dashboard','products','invoices','reports','settings'];
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                btn.classList.toggle('active', navOrder[i] === page);
            });
        }
        function goBack() { switchPage('dashboard'); }

        function renderPage(page) {
            const container = document.getElementById('mainContent');
            if (page === 'dashboard') renderDashboard(container);
            else if (page === 'products') renderProductsPage(container);
            else if (page === 'invoices') renderInvoicesPage(container);
            else if (page === 'reports') renderReportsPage(container);
            else if (page === 'settings') renderSettingsPage(container);
            else if (page === 'history') renderHistoryPage(container);
        }

        // ---------- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø­ØµØ§Ø¡Ø§Øª ÙƒØ§Ù…Ù„Ø© Ø§Ù„ØªÙ„ÙˆÙŠÙ†) ----------
        function renderDashboard(container) {
            const today = new Date().toDateString();
            const todayInvoices = invoices.filter(inv => new Date(inv.date).toDateString() === today);
            const salesToday = todayInvoices.reduce((s,i) => s + i.total, 0);
            const profitToday = todayInvoices.reduce((s,i) => s + (i.profit || 0), 0);
            const ordersToday = todayInvoices.length;
            const customersCount = customersDB.length;

            let html = `
                <div style="display: grid; grid-template-columns: repeat(2,1fr); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-coins"></i></div><div class="stat-value">${salesToday}</div><div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-chart-line"></i></div><div class="stat-value">${profitToday}</div><div class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-shopping-bag"></i></div><div class="stat-value">${ordersToday}</div><div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div><div class="stat-value">${customersCount}</div><div class="stat-label">Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯</div></div>
                </div>
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 20px; font-weight: 700;"><i class="fas fa-bolt" style="color: var(--accent-1);"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                        <span style="display: flex; gap: 12px;">
                            <button class="btn btn-outline" style="padding: 12px 16px;" onclick="openModal('searchInvoiceModal')"><i class="fas fa-search"></i> Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù…</button>
                            <button class="btn btn-outline" style="padding: 12px 16px;" onclick="openModal('monthlyInvoiceModal')"><i class="fas fa-calendar-alt"></i> ÙØ§ØªÙˆØ±Ø© Ø´Ù‡Ø±ÙŠØ©</button>
                        </span>
                    </div>
                    <div class="actions-grid">
                        <div class="action-item" onclick="switchPage('invoices')"><div class="action-icon"><i class="fas fa-plus"></i></div><span class="action-label">ÙØ§ØªÙˆØ±Ø©</span></div>
                        <div class="action-item" onclick="openModal('importModal')"><div class="action-icon"><i class="fas fa-file-import"></i></div><span class="action-label">Ø§Ø³ØªÙŠØ±Ø§Ø¯</span></div>
                        <div class="action-item" onclick="switchPage('products')"><div class="action-icon"><i class="fas fa-box"></i></div><span class="action-label">Ù…Ù†ØªØ¬Ø§Øª</span></div>
                        <div class="action-item" onclick="switchPage('reports')"><div class="action-icon"><i class="fas fa-chart-pie"></i></div><span class="action-label">ØªÙ‚Ø§Ø±ÙŠØ±</span></div>
                    </div>
                </div>
                <div>
                    <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px;"><i class="fas fa-clock" style="color: var(--accent-2);"></i> Ø¢Ø®Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
                    <div style="background: white; border-radius: 28px; border: 1px solid var(--gray-100); overflow: hidden;">
            `;
            const recent = invoices.slice(-5).reverse();
            if (recent.length === 0) html += '<div style="padding: 24px; text-align: center; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø¨Ø¹Ø¯</div>';
            else {
                recent.forEach(inv => {
                    html += `<div style="display: flex; align-items: center; padding: 18px; border-bottom: 1px solid var(--gray-100); cursor: pointer;" onclick="viewInvoiceDetails('${inv.number}')">
                                <div style="width: 48px; height: 48px; background: rgba(255,138,156,0.1); border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-left: 16px;"><i class="fas fa-receipt" style="color: var(--accent-1);"></i></div>
                                <div style="flex:1;"><div style="font-weight: 700;">${inv.number}</div><div style="font-size: 13px; color: var(--gray-500);">${new Date(inv.date).toLocaleDateString('ar-SA')} Â· ${inv.customerName || 'Ø¹Ù…ÙŠÙ„Ø©'}</div></div>
                                <div style="font-weight: 700; color: var(--accent-1);">${inv.total} Ø±.Ø³</div>
                            </div>`;
                });
            }
            html += `</div></div>`;
            container.innerHTML = html;
        }

        // ---------- ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± Ø¹Ù†ÙˆØ§Ù†) ----------
        function renderProductsPage(container) {
            let html = `
                <div class="products-header">
                    <div class="products-title">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                    <div class="products-actions">
                        <button onclick="openBarcodeScanner()" title="Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯"><i class="fas fa-camera"></i></button>
                        <button onclick="openModal('addProductModal')"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div style="position: relative; margin-bottom: 20px;">
                    <input type="text" class="form-control" id="productSearchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." style="padding-left: 50px;" autocomplete="off">
                    <i class="fas fa-search" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--gray-500);"></i>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="products-grid-container" id="productsGridContainer">
                    <div class="products-grid" id="productsGrid"></div>
                </div>
            `;
            container.innerHTML = html;
            renderProductsGrid();
            setupProductsSearch();
        }

        function renderProductsGrid(filter = '') {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;
            let filtered = filter ? products.filter(p => p.name.includes(filter) || p.barcode.includes(filter)) : products;
            grid.innerHTML = '';
            if (filtered.length === 0) { grid.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>'; return; }
            filtered.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-icon"><i class="fas ${p.icon || 'fa-box'}"></i></div>
                    <div style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">${escapeHTML(p.name)}</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--accent-1); margin-bottom: 8px;">${p.price} Ø±.Ø³</div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--gray-500); margin-bottom: 16px;">
                        <span>${p.barcode.slice(-6)}</span><span>Ù…Ø®Ø²ÙˆÙ†: ${p.stock}</span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" style="flex:1; padding: 12px;" onclick="editProduct(${p.id}); return false;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-primary" style="flex:1; padding: 12px;" onclick="addToInvoice(${p.id}); return false;"><i class="fas fa-cart-plus"></i></button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function escapeHTML(str) { return String(str).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c]); }

        function setupProductsSearch() {
            const input = document.getElementById('productSearchInput');
            const resultsDiv = document.getElementById('searchResults');
            let timeout;
            input.addEventListener('input', function() {
                clearTimeout(timeout);
                const q = this.value.trim();
                if (q.length < 2) { resultsDiv.style.display = 'none'; renderProductsGrid(''); return; }
                timeout = setTimeout(() => {
                    const filtered = products.filter(p => p.name.includes(q) || p.barcode.includes(q)).slice(0,5);
                    resultsDiv.innerHTML = '';
                    if (filtered.length === 0) resultsDiv.innerHTML = '<div style="padding:20px; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                    else {
                        filtered.forEach(p => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `<div style="width:40px; height:40px; background:var(--gradient); border-radius:14px; display:flex; align-items:center; justify-content:center; color:white; margin-left:16px;"><i class="fas ${p.icon || 'fa-box'}"></i></div>
                                              <div style="flex:1;"><div style="font-weight:600;">${p.name}</div><div style="font-size:12px;">${p.barcode}</div></div>
                                              <div style="font-weight:700; color:var(--accent-1);">${p.price} Ø±.Ø³</div>`;
                            item.onclick = () => { addToInvoice(p.id); input.value = ''; resultsDiv.style.display = 'none'; renderProductsGrid(''); };
                            resultsDiv.appendChild(item);
                        });
                    }
                    resultsDiv.style.display = 'block';
                    renderProductsGrid(q);
                }, 400);
            });
            document.addEventListener('click', e => { if (!input.contains(e.target) && !resultsDiv.contains(e.target)) resultsDiv.style.display = 'none'; });
        }

        // ---------- ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¹ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† ----------
        async function openBarcodeScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                stream.getTracks().forEach(t => t.stop());
                const codeReader = new ZXing.BrowserMultiFormatReader();
                codeReader.decodeOnceFromVideoDevice(undefined, 'video').then(result => {
                    const barcode = result.text;
                    showToast('ØªÙ… Ø§Ù„Ù…Ø³Ø­: ' + barcode, 'ğŸ“·');
                    const product = products.find(p => p.barcode === barcode);
                    if (product) addToInvoice(product.id);
                    else if (confirm('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ø§Ù„Ø¢Ù†ØŸ')) {
                        openModal('addProductModal');
                        document.getElementById('newProductBarcode').value = barcode;
                    }
                    codeReader.reset();
                }).catch(() => { alert('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯'); codeReader.reset(); });
            } catch { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†.'); }
        }

        // ---------- ØµÙØ­Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø«Ø§Ø¨ØªØ© Ù„Ø§ ØªØºÙŠÙŠØ±) ----------
        function renderInvoicesPage(container) {
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div class="customer-card">
                        <div style="display:flex; align-items:center; gap:14px; margin-bottom:20px;">
                            <i class="fas fa-user" style="width:48px; height:48px; background:rgba(255,138,156,0.1); border-radius:18px; display:flex; align-items:center; justify-content:center; color:var(--accent-1); font-size:22px;"></i>
                            <span style="font-weight:700; font-size:18px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„Ø©</span>
                        </div>
                        <div class="form-group" style="position:relative;">
                            <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" class="form-control" id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„Ø©" autocomplete="off">
                            <div id="customerDatalist" class="datalist-customers"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                            <input type="tel" class="form-control" id="customerPhone" placeholder="771234567">
                        </div>
                    </div>
                    <div class="products-card">
                        <div style="display:flex; align-items:center; gap:14px; margin-bottom:20px;">
                            <i class="fas fa-box" style="width:48px; height:48px; background:rgba(255,138,156,0.1); border-radius:18px; display:flex; align-items:center; justify-content:center; color:var(--accent-1); font-size:22px;"></i>
                            <span style="font-weight:700; font-size:18px;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                        </div>
                        <div style="position:relative; margin-bottom:20px;">
                            <input type="text" class="form-control" id="invoiceProductSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." style="padding-left:50px;">
                            <i class="fas fa-search" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); color:var(--gray-500);"></i>
                            <div class="search-results" id="invoiceSearchResults"></div>
                        </div>
                        <div id="invoiceItemsList" style="max-height:220px; overflow-y:auto;"></div>
                    </div>
                    <div class="summary-card">
                        <div style="display:flex; align-items:center; gap:14px; margin-bottom:20px;">
                            <i class="fas fa-calculator" style="width:48px; height:48px; background:rgba(255,138,156,0.1); border-radius:18px; display:flex; align-items:center; justify-content:center; color:var(--accent-1); font-size:22px;"></i>
                            <span style="font-weight:700; font-size:18px;">Ù…Ù„Ø®Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; padding:12px 0;"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span><span id="subtotal" style="font-weight:600;">0 Ø±.Ø³</span></div>
                        <div style="display:flex; justify-content:space-between; padding:12px 0;"><span>Ø§Ù„ØªÙˆØµÙŠÙ„</span><span><input type="number" id="deliveryCost" value="0" min="0" style="width:80px; padding:10px; border:1px solid var(--gray-200); border-radius:30px; text-align:center;"> Ø±.Ø³</span></div>
                        <div style="display:flex; justify-content:space-between; padding:12px 0;"><span>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</span><span id="profit" style="color:var(--success); font-weight:700;">0 Ø±.Ø³</span></div>
                        <div style="border-top:1px solid var(--gray-100); margin:16px 0;"></div>
                        <div style="display:flex; justify-content:space-between; font-size:22px; font-weight:700;"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span id="total" style="color:var(--accent-1);">0 Ø±.Ø³</span></div>
                    </div>
                    <div style="display:flex; gap:12px; margin-bottom:8px;">
                        <button class="btn btn-wa" style="flex:1;" onclick="openWhatsAppModal()"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</button>
                        <button class="btn btn-primary" style="flex:1;" onclick="saveInvoice()"><i class="fas fa-save"></i> Ø­ÙØ¸</button>
                        <button class="btn btn-outline" style="flex:1;" onclick="printInvoice()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                    <div style="text-align:center; font-size:14px; color:var(--gray-500);">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <span id="invoiceNumber" style="font-weight:700; color:var(--accent-1);">LVN-${new Date().getFullYear()}${(new Date().getMonth()+1).toString().padStart(2,'0')}${new Date().getDate().toString().padStart(2,'0')}-001</span></div>
                </div>
            `;
            generateInvoiceNumber();
            updateInvoiceSummary();
            setupInvoiceSearch();
            setupCustomerAutocomplete();
        }

        // Ø¨Ø­Ø« Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©)
        function setupInvoiceSearch() {
            const input = document.getElementById('invoiceProductSearch');
            const results = document.getElementById('invoiceSearchResults');
            let timeout;
            input.addEventListener('input', function() {
                clearTimeout(timeout);
                const q = this.value.trim();
                if (q.length < 2) { results.style.display = 'none'; return; }
                timeout = setTimeout(() => {
                    const filtered = products.filter(p => p.name.includes(q) || p.barcode.includes(q)).slice(0,5);
                    results.innerHTML = '';
                    if (filtered.length === 0) results.innerHTML = '<div style="padding:20px; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                    else {
                        filtered.forEach(p => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `<div style="width:40px; height:40px; background:var(--gradient); border-radius:14px; display:flex; align-items:center; justify-content:center; color:white; margin-left:16px;"><i class="fas ${p.icon || 'fa-box'}"></i></div>
                                              <div style="flex:1;"><div style="font-weight:600;">${p.name}</div><div style="font-size:12px;">${p.price} Ø±.Ø³</div></div>`;
                            item.onclick = () => { addToInvoice(p.id); input.value = ''; results.style.display = 'none'; };
                            results.appendChild(item);
                        });
                    }
                    results.style.display = 'block';
                }, 400);
            });
            document.addEventListener('click', e => { if (!input.contains(e.target) && !results.contains(e.target)) results.style.display = 'none'; });
        }

        // Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        function setupCustomerAutocomplete() {
            const input = document.getElementById('customerName');
            const list = document.getElementById('customerDatalist');
            input.addEventListener('input', function() {
                const val = this.value.trim();
                if (val.length < 1) { list.style.display = 'none'; return; }
                const matches = customersDB.filter(c => c.name && c.name.includes(val)).slice(0,5);
                if (matches.length) {
                    list.innerHTML = matches.map(c => `<div class="datalist-item" data-phone="${c.phone}">${c.name} - ${c.phone}</div>`).join('');
                    list.style.display = 'block';
                    list.querySelectorAll('.datalist-item').forEach(el => {
                        el.onclick = () => {
                            input.value = el.textContent.split(' - ')[0];
                            document.getElementById('customerPhone').value = el.dataset.phone;
                            list.style.display = 'none';
                        };
                    });
                } else list.style.display = 'none';
            });
            document.addEventListener('click', e => { if (!input.contains(e.target) && !list.contains(e.target)) list.style.display = 'none'; });
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©
        function addToInvoice(productId) {
            const p = products.find(p => p.id === productId);
            if (!p) return;
            if (currentPage !== 'invoices') switchPage('invoices');
            const existing = invoiceItems.find(i => i.id === productId);
            if (existing) existing.quantity += 1;
            else invoiceItems.push({ ...p, quantity: 1 });
            renderInvoiceItems();
            updateInvoiceSummary();
            showToast('Ø£Ø¶ÙŠÙ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', 'ğŸ›ï¸');
        }

        function renderInvoiceItems() {
            const container = document.getElementById('invoiceItemsList');
            if (!container) return;
            if (invoiceItems.length === 0) { container.innerHTML = '<div style="text-align:center; padding:32px; color:var(--gray-500);"><i class="fas fa-shopping-cart" style="font-size:40px; margin-bottom:12px;"></i><p>Ù„Ù… ØªÙØ¶Ù Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯</p></div>'; return; }
            container.innerHTML = '';
            invoiceItems.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'invoice-item';
                div.innerHTML = `
                    <div style="flex:1;"><div style="font-weight:700;">${escapeHTML(item.name)}</div><div style="font-size:13px; color:var(--gray-500);">${item.price} Ø±.Ø³</div></div>
                    <div style="display:flex; align-items:center; gap:12px; background:white; padding:8px 16px; border-radius:40px; box-shadow:var(--shadow-sm);">
                        <button onclick="changeQuantity(${idx}, -1); return false;" style="width:32px; height:32px; border-radius:50%; border:none; background:var(--gradient); color:white; font-weight:700; cursor:pointer;">-</button>
                        <span style="min-width:28px; text-align:center; font-weight:600;">${item.quantity}</span>
                        <button onclick="changeQuantity(${idx}, 1); return false;" style="width:32px; height:32px; border-radius:50%; border:none; background:var(--gradient); color:white; font-weight:700; cursor:pointer;">+</button>
                    </div>
                    <div style="font-weight:700; color:var(--accent-1); margin-right:16px;">${item.price * item.quantity} Ø±.Ø³</div>
                    <div onclick="removeInvoiceItem(${idx}); return false;" style="color:var(--danger); margin-right:8px; font-size:20px; cursor:pointer;"><i class="fas fa-trash"></i></div>
                `;
                container.appendChild(div);
            });
        }

        function changeQuantity(idx, delta) { if (invoiceItems[idx]) { invoiceItems[idx].quantity = Math.max(1, invoiceItems[idx].quantity + delta); renderInvoiceItems(); updateInvoiceSummary(); } }
        function removeInvoiceItem(idx) { invoiceItems.splice(idx, 1); renderInvoiceItems(); updateInvoiceSummary(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ğŸ—‘ï¸'); }

        function updateInvoiceSummary() {
            const subtotal = invoiceItems.reduce((s,i) => s + i.price * i.quantity, 0);
            const delivery = parseFloat(document.getElementById('deliveryCost')?.value || 0);
            const profit = invoiceItems.reduce((s,i) => s + (i.price - i.cost) * i.quantity, 0) - delivery;
            const total = subtotal + delivery;
            if (document.getElementById('subtotal')) document.getElementById('subtotal').innerText = subtotal + ' Ø±.Ø³';
            if (document.getElementById('profit')) document.getElementById('profit').innerText = profit + ' Ø±.Ø³';
            if (document.getElementById('total')) document.getElementById('total').innerText = total + ' Ø±.Ø³';
        }

        function generateInvoiceNumber() {
            const now = new Date();
            const num = `LVN-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;
            const el = document.getElementById('invoiceNumber');
            if (el) el.innerText = num;
        }

        // ---------- ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ----------
        function openWhatsAppModal() {
            if (invoiceItems.length === 0) { alert('Ø£Ø¶ÙŠÙÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹'); return; }
            document.getElementById('whatsappPhoneNumber').value = document.getElementById('customerPhone').value;
            document.getElementById('whatsappPreview').innerText = buildWhatsAppMessage();
            openModal('whatsappModal');
        }

        function buildWhatsAppMessage() {
            const firstName = document.getElementById('customerName').value || 'Ø¹Ù…ÙŠÙ„Ø©';
            const orderId = document.getElementById('invoiceNumber').innerText.replace('LVN-', '');
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ar-SA') + ' ' + now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            let itemsText = '';
            invoiceItems.forEach(i => { itemsText += `   â€¢ ${i.name} (${i.quantity} Ã— ${i.price}) = ${i.quantity * i.price} Ø±ÙŠØ§Ù„\n`; });
            const total = invoiceItems.reduce((s,i) => s + i.price * i.quantity, 0) + parseFloat(document.getElementById('deliveryCost')?.value || 0);
            return settings.whatsappTemplate
                .replace(/{firstName}/g, firstName)
                .replace(/{orderId}/g, orderId)
                .replace(/{formattedDate}/g, formattedDate)
                .replace(/{items}/g, itemsText)
                .replace(/{total}/g, total);
        }

        function sendWhatsApp() {
            let phone = document.getElementById('whatsappPhoneNumber').value.replace(/\D/g, '');
            if (!phone) { alert('Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'); return; }
            if (settings.codeBehavior === 'prepend') {
                if (phone.startsWith('0')) phone = phone.substring(1);
                phone = settings.countryCode + phone;
            }
            // Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            if (invoiceItems.length > 0) autoSaveInvoice();
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(buildWhatsAppMessage())}`;
            window.open(url, '_blank');
            closeModal('whatsappModal');
            showToast('ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©', 'ğŸ“¨');
        }

        // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¯ÙˆÙ† Ø¥Ø²Ø¹Ø§Ø¬
        function autoSaveInvoice() {
            if (invoiceItems.length === 0) return;
            const invoice = {
                number: document.getElementById('invoiceNumber').innerText,
                date: new Date().toISOString(),
                customerName: document.getElementById('customerName').value || 'Ø¹Ù…ÙŠÙ„Ø©',
                customerPhone: document.getElementById('customerPhone').value,
                items: invoiceItems.map(i => ({ ...i })),
                subtotal: parseFloat(document.getElementById('subtotal').innerText.replace(/[^\d]/g, '')),
                delivery: parseFloat(document.getElementById('deliveryCost').value || 0),
                profit: parseFloat(document.getElementById('profit').innerText.replace(/[^\d]/g, '')),
                total: parseFloat(document.getElementById('total').innerText.replace(/[^\d]/g, ''))
            };
            invoices.push(invoice);
            saveInvoices();
            updateCustomersDB();
            // Ù„Ø§ Ù†ÙØ±Øº Ø§Ù„Ø¹Ù†Ø§ØµØ± â€“ Ù†ØªØ±ÙƒÙ‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        }

        // Ø­ÙØ¸ ÙŠØ¯ÙˆÙŠ
        function saveInvoice() {
            if (invoiceItems.length === 0) { alert('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©'); return; }
            const invoice = {
                number: document.getElementById('invoiceNumber').innerText,
                date: new Date().toISOString(),
                customerName: document.getElementById('customerName').value || 'Ø¹Ù…ÙŠÙ„Ø©',
                customerPhone: document.getElementById('customerPhone').value,
                items: invoiceItems.map(i => ({ ...i })),
                subtotal: parseFloat(document.getElementById('subtotal').innerText.replace(/[^\d]/g, '')),
                delivery: parseFloat(document.getElementById('deliveryCost').value || 0),
                profit: parseFloat(document.getElementById('profit').innerText.replace(/[^\d]/g, '')),
                total: parseFloat(document.getElementById('total').innerText.replace(/[^\d]/g, ''))
            };
            invoices.push(invoice);
            saveInvoices();
            updateCustomersDB();
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'ğŸ’¾');
            // ØªÙØ±ÙŠØº Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙŠØ¯ÙˆÙŠ
            invoiceItems = [];
            renderInvoiceItems();
            updateInvoiceSummary();
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('deliveryCost').value = 0;
            generateInvoiceNumber();
            if (currentPage === 'dashboard') renderDashboard(document.getElementById('mainContent'));
        }

        // ---------- Ø·Ø¨Ø§Ø¹Ø© PDF ----------
        function printInvoice() {
            const win = window.open('', '_blank');
            win.document.write(`
                <html dir="rtl"><head><meta charset="UTF-8"><title>ÙØ§ØªÙˆØ±Ø© Ù„ÙˆØ±Ú¤ÙŠÙ†</title>
                <style>
                    body { font-family: 'IBM Plex Sans Arabic', sans-serif; padding: 30px; background: #fff; color: #2C3A4F; } 
                    .invoice { max-width: 600px; margin: auto; border: 1px solid #E0D6D0; border-radius: 28px; padding: 30px; box-shadow: 0 12px 24px rgba(0,0,0,0.04); }
                    .header { display: flex; justify-content: space-between; align-items: center; }
                    .logo { font-size: 28px; font-weight: 700; background: linear-gradient(145deg, #FF8A9C, #A7C7E7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th { border-bottom: 2px solid #FF8A9C; padding: 12px 0; text-align: right; }
                    td { padding: 12px 0; border-bottom: 1px solid #F0EBE8; }
                    .total { font-size: 22px; font-weight: 700; color: #FF8A9C; text-align: left; margin-top: 20px; }
                </style></head>
                <body>
                    <div class="invoice">
                        <div class="header"><span class="logo">${settings.storeName}</span><span>ÙØ§ØªÙˆØ±Ø©</span></div>
                        <p style="color: #8F8A88;">Ø±Ù‚Ù…: ${document.getElementById('invoiceNumber').innerText}</p>
                        <p>Ø§Ù„Ø¹Ù…ÙŠÙ„Ø©: ${document.getElementById('customerName').value || 'Ø¹Ù…ÙŠÙ„Ø©'}</p>
                        <table>
                            <tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>
                            ${invoiceItems.map(i => `<tr><td>${i.name}</td><td>${i.quantity}</td><td>${i.price}</td><td>${i.quantity * i.price}</td></tr>`).join('')}
                        </table>
                        <div style="display: flex; justify-content: space-between;"><span>Ø§Ù„ØªÙˆØµÙŠÙ„:</span><span>${document.getElementById('deliveryCost').value || 0} Ø±.Ø³</span></div>
                        <div class="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${document.getElementById('total').innerText}</div>
                        <p style="margin-top: 40px; text-align: center; color: #FF8A9C;">Ù…Ù…ØªÙ†ÙŠÙ† Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ Ù„ÙˆØ±Ú¤ÙŠÙ† ğŸ¤</p>
                    </div>
                </body></html>
            `);
            win.document.close();
            win.print();
        }

        // ---------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ----------
        function addNewProduct() {
            const name = document.getElementById('newProductName').value;
            let barcode = document.getElementById('newProductBarcode').value;
            if (!barcode) barcode = generateBarcode();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const cost = parseFloat(document.getElementById('newProductCost').value) || 0;
            const stock = parseInt(document.getElementById('newProductStock').value) || 0;
            const category = document.getElementById('newProductCategory').value;
            if (!name || !barcode || isNaN(price)) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'); return; }
            const newId = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
            products.unshift({ id: newId, name, barcode, price, cost, stock, category, icon: 'fa-box' });
            saveProducts();
            closeModal('addProductModal');
            renderProductsGrid();
            showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬', 'âœ…');
            ['newProductName','newProductBarcode','newProductCost','newProductPrice','newProductStock'].forEach(id => document.getElementById(id).value = '');
        }

        function editProduct(id) {
            const p = products.find(p => p.id === id);
            if (!p) return;
            document.getElementById('editProductId').value = p.id;
            document.getElementById('editProductName').value = p.name;
            document.getElementById('editProductBarcode').value = p.barcode;
            document.getElementById('editProductPrice').value = p.price;
            document.getElementById('editProductCost').value = p.cost;
            document.getElementById('editProductStock').value = p.stock;
            const catSelect = document.getElementById('editProductCategory');
            catSelect.innerHTML = ['Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©','Ù…ÙƒÙŠØ§Ø¬','Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø´Ø¹Ø±','Ø¹Ø·ÙˆØ±','Ù…Ù†ØªØ¬Ø§Øª Ø·Ø¨ÙŠØ¹ÙŠØ©'].map(c => `<option ${c === p.category ? 'selected' : ''}>${c}</option>`).join('');
            openModal('editProductModal');
        }

        function updateProduct() {
            const id = parseInt(document.getElementById('editProductId').value);
            const p = products.find(p => p.id === id);
            if (p) {
                p.name = document.getElementById('editProductName').value;
                p.barcode = document.getElementById('editProductBarcode').value;
                p.price = parseFloat(document.getElementById('editProductPrice').value);
                p.cost = parseFloat(document.getElementById('editProductCost').value);
                p.stock = parseInt(document.getElementById('editProductStock').value);
                p.category = document.getElementById('editProductCategory').value;
                saveProducts();
                closeModal('editProductModal');
                renderProductsGrid();
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬', 'ğŸ”„');
            }
        }

        function deleteProduct() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
            const id = parseInt(document.getElementById('editProductId').value);
            products = products.filter(p => p.id !== id);
            saveProducts();
            closeModal('editProductModal');
            renderProductsGrid();
            showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'ğŸ—‘ï¸');
        }

        // ---------- Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© ----------
        function deleteInvoice(number) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) return;
            invoices = invoices.filter(inv => inv.number !== number);
            saveInvoices();
            updateCustomersDB();
            if (currentPage === 'history') renderHistoryPage(document.getElementById('mainContent'));
            else if (currentPage === 'dashboard') renderDashboard(document.getElementById('mainContent'));
            showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'ğŸ—‘ï¸');
        }

        // ---------- Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ----------
        function viewInvoiceDetails(number) {
            const inv = invoices.find(i => i.number === number);
            if (!inv) { alert('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
            const itemsHtml = inv.items.map(i => `<div style="display:flex; justify-content:space-between; padding:8px 0;"><span>${i.name} (${i.quantity} Ã— ${i.price})</span><span style="font-weight:600;">${i.quantity * i.price} Ø±.Ø³</span></div>`).join('');
            document.getElementById('invoiceDetailsContent').innerHTML = `
                <h4 style="margin-bottom:16px;">${inv.number}</h4>
                <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„Ø©:</strong> ${inv.customerName || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(inv.date).toLocaleString('ar-SA')}</p>
                <div style="border-top:1px solid var(--gray-100); margin:16px 0;"></div>
                ${itemsHtml}
                <div style="border-top:1px solid var(--gray-100); margin:16px 0;"></div>
                <div style="display:flex; justify-content:space-between;"><span>Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${inv.delivery} Ø±.Ø³</span></div>
                <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:700; margin-top:12px;"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span style="color:var(--accent-1);">${inv.total} Ø±.Ø³</span></div>
                <button class="btn btn-outline" style="width:100%; margin-top:24px;" onclick="closeModal('invoiceDetailsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
                <button class="btn btn-outline" style="width:100%; margin-top:12px; color:var(--danger); border-color:var(--danger);" onclick="deleteInvoice('${inv.number}'); closeModal('invoiceDetailsModal');">Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            `;
            openModal('invoiceDetailsModal');
        }

        // ---------- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø¨Ø±Ù‚Ù… ----------
        function findInvoiceByNumber() {
            const num = document.getElementById('invoiceSearchNumber').value.trim();
            if (!num) { alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©'); return; }
            const inv = invoices.find(i => i.number === num);
            const resultDiv = document.getElementById('invoiceSearchResult');
            if (!inv) resultDiv.innerHTML = '<p style="color:red; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</p>';
            else {
                resultDiv.innerHTML = `<div style="background:var(--gray-50); border-radius:24px; padding:20px; cursor:pointer;" onclick="viewInvoiceDetails('${inv.number}'); closeModal('searchInvoiceModal');">
                    <p><strong>${inv.number}</strong></p>
                    <p>Ø§Ù„Ø¹Ù…ÙŠÙ„Ø©: ${inv.customerName}</p>
                    <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(inv.date).toLocaleDateString('ar-SA')}</p>
                    <p style="color:var(--accent-1); font-weight:700;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${inv.total} Ø±.Ø³</p>
                </div>`;
            }
        }

        // ---------- ÙØ§ØªÙˆØ±Ø© Ø´Ù‡Ø±ÙŠØ© ----------
        function generateMonthlyInvoice() {
            const customerSelect = document.getElementById('monthlyCustomerSelect');
            const customerPhone = customerSelect.value;
            const customerName = customerSelect.selectedOptions[0]?.text.split(' - ')[0] || '';
            const month = document.getElementById('monthlyMonth').value;
            if (!month || !customerPhone) { alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„Ø© ÙˆØ§Ù„Ø´Ù‡Ø±'); return; }
            const [year, monthNum] = month.split('-');
            const monthlyInvoices = invoices.filter(inv => 
                inv.customerPhone === customerPhone && 
                new Date(inv.date).getFullYear() == year && 
                (new Date(inv.date).getMonth() + 1) == parseInt(monthNum)
            );
            if (monthlyInvoices.length === 0) { document.getElementById('monthlyInvoiceResult').innerHTML = '<p style="color:red;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>'; return; }
            let items = [];
            monthlyInvoices.forEach(inv => inv.items.forEach(it => {
                const found = items.find(i => i.id === it.id);
                if (found) found.quantity += it.quantity;
                else items.push({ ...it });
            }));
            const subtotal = items.reduce((s,i) => s + i.price * i.quantity, 0);
            const totalProfit = items.reduce((s,i) => s + (i.price - i.cost) * i.quantity, 0);
            const total = subtotal; // Ø¨Ø¯ÙˆÙ† ØªÙˆØµÙŠÙ„
            const itemsHtml = items.map(i => `<div style="display:flex; justify-content:space-between;"><span>${i.name} (${i.quantity} Ã— ${i.price})</span><span>${i.quantity * i.price} Ø±.Ø³</span></div>`).join('');
            document.getElementById('monthlyInvoiceResult').innerHTML = `
                <div style="background:var(--gray-50); border-radius:24px; padding:20px; margin-top:20px;">
                    <h4 style="margin-bottom:12px;">ÙØ§ØªÙˆØ±Ø© Ø´Ù‡Ø± ${month} Ù„Ù„Ø¹Ù…ÙŠÙ„Ø© ${customerName}</h4>
                    ${itemsHtml}
                    <div style="border-top:1px solid var(--gray-200); margin:12px 0;"></div>
                    <div style="display:flex; justify-content:space-between; font-weight:700;"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span style="color:var(--accent-1);">${total} Ø±.Ø³</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</span><span style="color:var(--success);">${totalProfit} Ø±.Ø³</span></div>
                </div>
            `;
        }

        // ---------- ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ----------
        function renderReportsPage(container) {
            container.innerHTML = `
                <div style="padding:4px 0;">
                    <h3 style="font-size:24px; font-weight:700; margin-bottom:24px;">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                    <div style="background:white; border-radius:32px; padding:24px; margin-bottom:24px; box-shadow:var(--shadow-sm);">
                        <canvas id="salesChart" style="width:100%; height:200px;"></canvas>
                    </div>
                    <div style="background:white; border-radius:32px; padding:24px; margin-bottom:24px; box-shadow:var(--shadow-sm);">
                        <canvas id="categoryChart" style="width:100%; height:200px;"></canvas>
                    </div>
                    <div style="background:white; border-radius:32px; padding:24px; box-shadow:var(--shadow-sm);">
                        <h4 style="font-size:20px; margin-bottom:20px;">ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„</h4>
                        <div id="detailedReport" style="line-height:2.2;"></div>
                    </div>
                </div>
            `;
            generateSalesChart();
            generateCategoryChart();
            generateDetailedReport();
        }

        function generateSalesChart() {
            const last7Days = [...Array(7)].map((_,i) => { let d = new Date(); d.setDate(d.getDate()-i); return d.toDateString(); }).reverse();
            const salesData = last7Days.map(day => invoices.filter(inv => new Date(inv.date).toDateString() === day).reduce((s,inv) => s + inv.total, 0));
            new Chart(document.getElementById('salesChart'), {
                type: 'line',
                data: { labels: ['Ù‚Ø¨Ù„ 6','Ù‚Ø¨Ù„ 5','Ù‚Ø¨Ù„ 4','Ù‚Ø¨Ù„ 3','Ù‚Ø¨Ù„ 2','Ø£Ù…Ø³','Ø§Ù„ÙŠÙˆÙ…'], 
                        datasets: [{ label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', data: salesData, borderColor: '#FF8A9C', backgroundColor: 'rgba(255,138,156,0.1)', tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function generateCategoryChart() {
            const catMap = {};
            invoices.forEach(inv => inv.items.forEach(it => { catMap[it.category] = (catMap[it.category] || 0) + it.quantity; }));
            new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(catMap).length ? Object.keys(catMap) : ['Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª'], 
                        datasets: [{ data: Object.keys(catMap).length ? Object.values(catMap) : [1], backgroundColor: ['#FF8A9C','#A7C7E7','#FFD3B5','#A3D9A5','#D4B8D4'] }] }
            });
        }

        function generateDetailedReport() {
            const totalSales = invoices.reduce((s,i) => s + i.total, 0);
            const totalProfit = invoices.reduce((s,i) => s + (i.profit || 0), 0);
            const totalInvoices = invoices.length;
            const avgOrder = totalInvoices ? (totalSales / totalInvoices).toFixed(2) : 0;
            document.getElementById('detailedReport').innerHTML = `
                <p><strong>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> ${totalSales} Ø±.Ø³</p>
                <p><strong>ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­:</strong> ${totalProfit} Ø±.Ø³</p>
                <p><strong>ğŸ§¾ Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${totalInvoices}</p>
                <p><strong>ğŸ“Š Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${avgOrder} Ø±.Ø³</p>
            `;
        }

        // ---------- ØµÙØ­Ø© Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ù…Ø¹ Ø­Ø°Ù ÙˆØ¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„) ----------
        function renderHistoryPage(container) {
            let html = '<h3 style="font-size:26px; font-weight:700; margin-bottom:24px;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>';
            if (invoices.length === 0) html += '<div style="background:white; border-radius:28px; padding:40px; text-align:center; color:var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©</div>';
            else {
                invoices.slice().reverse().forEach(inv => {
                    html += `<div style="background:white; border-radius:24px; padding:20px; margin-bottom:16px; border:1px solid var(--gray-100); cursor:pointer;" onclick="viewInvoiceDetails('${inv.number}')">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-weight:700; font-size:16px;">${inv.number}</span>
                                    <span style="color:var(--accent-1); font-weight:700;">${inv.total} Ø±.Ø³</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:14px; color:var(--gray-500);">
                                    <span>${new Date(inv.date).toLocaleDateString('ar-SA')}</span>
                                    <span>${inv.customerName || 'Ø¹Ù…ÙŠÙ„Ø©'}</span>
                                </div>
                            </div>`;
                });
            }
            container.innerHTML = html;
        }

        // ---------- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙƒÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØªØ¹Ù…Ù„ 100%) ----------
        function renderSettingsPage(container) {
            // Ù…Ù„Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
            setTimeout(() => {
                const select = document.getElementById('monthlyCustomerSelect');
                if (select) {
                    select.innerHTML = customersDB.map(c => `<option value="${c.phone}">${c.name} - ${c.phone}</option>`).join('');
                    if (customersDB.length === 0) select.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</option>';
                }
            }, 100);
            container.innerHTML = `
                <div style="margin-bottom:24px;">
                    <h3 style="font-size:24px; font-weight:700; margin-bottom:8px;">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
                    <p style="color:var(--gray-500);">Ø®ØµÙ‘ØµÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ</p>
                </div>
                <div class="settings-list">
                    <div class="settings-item" onclick="openModal('settingsGeneral')">
                        <div class="settings-icon"><i class="fas fa-sliders-h"></i></div>
                        <div class="settings-content"><div class="settings-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div><div class="settings-subtitle">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠØŒ Ø§Ù„Ù„ØºØ©</div></div>
                        <div class="settings-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="settings-item" onclick="openModal('settingsCountryCode')">
                        <div class="settings-icon"><i class="fas fa-globe"></i></div>
                        <div class="settings-content"><div class="settings-title">Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨</div><div class="settings-subtitle" id="countryCodeDisplay">${settings.countryCode} (${settings.codeBehavior === 'prepend' ? 'Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©' : 'Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ©'})</div></div>
                        <div class="settings-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="settings-item" onclick="openModal('settingsTemplates')">
                        <div class="settings-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="settings-content"><div class="settings-title">Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div><div class="settings-subtitle">ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨</div></div>
                        <div class="settings-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="settings-item" onclick="openModal('settingsBackup')">
                        <div class="settings-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                        <div class="settings-content"><div class="settings-title">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</div><div class="settings-subtitle">ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div></div>
                        <div class="settings-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="settings-item" onclick="openModal('settingsAds')">
                        <div class="settings-icon"><i class="fas fa-bullhorn"></i></div>
                        <div class="settings-content"><div class="settings-title">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div><div class="settings-subtitle">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±ÙˆØ¶ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</div></div>
                        <div class="settings-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="settings-item" onclick="openModal('settingsCustomize')">
                        <div class="settings-icon"><i class="fas fa-paint-brush"></i></div>
                        <div class="settings-content"><div class="settings-title">ØªØ®ØµÙŠØµ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div><div class="settings-subtitle">Ø§Ù„Ø´Ø¹Ø§Ø±ØŒ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</div></div>
                        <div class="settings-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="settings-item" onclick="openModal('settingsSecurity')">
                        <div class="settings-icon"><i class="fas fa-shield-alt"></i></div>
                        <div class="settings-content"><div class="settings-title">Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©</div><div class="settings-subtitle">Ù‚ÙÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ PIN</div></div>
                        <div class="settings-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                </div>
            `;
        }

        // ---------- ØªÙˆØ§Ø¨Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ----------
        window.openModal = function(id) {
            if (id === 'settingsCountryCode') {
                const s = document.getElementById('countryCodeSelect');
                if (s) s.value = settings.countryCode;
                document.getElementById('customCountryCodeDiv').style.display = settings.countryCode === 'other' ? 'block' : 'none';
                document.querySelectorAll('input[name="codeBehavior"]').forEach(r => { if (r.value === settings.codeBehavior) r.checked = true; });
            }
            if (id === 'settingsTemplates') document.getElementById('whatsappTemplate').value = settings.whatsappTemplate;
            if (id === 'settingsGeneral') {
                document.getElementById('darkMode').value = settings.darkMode;
                document.getElementById('appLanguage').value = settings.language;
            }
            if (id === 'settingsSecurity') {
                document.getElementById('appLock').value = settings.appLock;
                document.getElementById('pinCode').value = settings.pinCode || '';
            }
            if (id === 'settingsCustomize') {
                document.getElementById('storeName').value = settings.storeName;
                document.getElementById('logoUrl').value = settings.logo || '';
            }
            document.getElementById(id).style.display = 'flex';
        };
        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; };
        window.addEventListener('click', e => { document.querySelectorAll('.modal').forEach(m => { if (e.target === m) closeModal(m.id); }); });

        function saveGeneral() {
            settings.darkMode = document.getElementById('darkMode').value;
            settings.language = document.getElementById('appLanguage').value;
            saveSettings();
            closeModal('settingsGeneral');
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©', 'âš™ï¸');
        }
        function saveCountryCode() {
            const select = document.getElementById('countryCodeSelect');
            settings.countryCode = select.value === 'other' ? (document.getElementById('customCountryCode').value || '967') : select.value;
            settings.codeBehavior = document.querySelector('input[name="codeBehavior"]:checked').value;
            saveSettings();
            document.getElementById('countryCodeDisplay').innerText = `${settings.countryCode} (${settings.codeBehavior === 'prepend' ? 'Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©' : 'Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ©'})`;
            closeModal('settingsCountryCode');
            showToast('ØªÙ… Ø­ÙØ¸ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©', 'ğŸŒ');
        }
        function saveTemplate() {
            settings.whatsappTemplate = document.getElementById('whatsappTemplate').value;
            saveSettings();
            closeModal('settingsTemplates');
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨', 'ğŸ“„');
        }
        function saveCustomization() {
            settings.storeName = document.getElementById('storeName').value;
            settings.logo = document.getElementById('logoUrl').value;
            saveSettings();
            closeModal('settingsCustomize');
            showToast('ØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'ğŸ¨');
        }
        function saveSecurity() {
            settings.appLock = document.getElementById('appLock').value;
            settings.pinCode = document.getElementById('pinCode').value;
            saveSettings();
            closeModal('settingsSecurity');
            showToast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†', 'ğŸ”’');
        }
        function sendAds() {
            const msg = document.getElementById('adMessage').value;
            if (!msg) { alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
            alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¥Ù„Ù‰ ${customersDB.length} Ø¹Ù…ÙŠÙ„Ø© (Ù…Ø­Ø§ÙƒØ§Ø©)`);
            closeModal('settingsAds');
        }
        function exportBackup() {
            const data = { products, invoices, settings };
            const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lorven_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            closeModal('settingsBackup');
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø©', 'ğŸ“¦');
        }
        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.products) { products = data.products; saveProducts(); }
                    if (data.invoices) { invoices = data.invoices; saveInvoices(); updateCustomersDB(); }
                    if (data.settings) { settings = { ...settings, ...data.settings }; saveSettings(); }
                    showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø©', 'âœ…');
                    closeModal('settingsBackup');
                    if (currentPage === 'settings') renderSettingsPage(document.getElementById('mainContent'));
                    else if (currentPage === 'dashboard') renderDashboard(document.getElementById('mainContent'));
                } catch { alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
            };
            reader.readAsText(file);
            document.getElementById('importFile').value = '';
        }

        // ---------- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ----------
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateTime();
            switchPage('dashboard');
        });
    </script>
</body>
</html>